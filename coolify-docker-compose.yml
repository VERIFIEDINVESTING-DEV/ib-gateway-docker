# Coolify-optimized Docker Compose for IB Gateway with FastAPI wrapper
# Deploy this via Coolify's Docker Compose deployment
#
# Required environment variables (set in Coolify UI):
#   IB Gateway:
#     - TWS_USERID: Your IBKR username
#     - TWS_PASSWORD: Your IBKR password
#     - VNC_SERVER_PASSWORD: Password for VNC access (SSH tunnel required)
#   IB API:
#     - JWT_SECRET: Secret for signing JWT tokens (min 32 chars)
#       Generate with: python -c "import secrets; print(secrets.token_urlsafe(32))"
#     - API_USERNAME: Username for API authentication
#     - API_PASSWORD: Bcrypt hash of API password
#       Generate with: python -c "from passlib.context import CryptContext; print(CryptContext(schemes=['bcrypt']).hash('your-password'))"
#
# VNC Access (for 2FA approval and debugging):
#   VNC is NOT exposed publicly. Use SSH tunnel:
#     ssh -L 5900:localhost:5900 user@your-coolify-server
#   Then connect VNC client to: localhost:5900
#
name: ib-gateway

services:
  # ===========================================================================
  # IB Gateway - Internal only, no public ports
  # ===========================================================================
  ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:latest
    restart: always
    environment:
      # Required credentials
      - TWS_USERID=${TWS_USERID:?}
      - TWS_PASSWORD=${TWS_PASSWORD:?}
      - VNC_SERVER_PASSWORD=${VNC_SERVER_PASSWORD:?}
      # Trading mode: paper, live, or both
      - TRADING_MODE=${TRADING_MODE:-paper}
      # Timezone
      - TIME_ZONE=${TIME_ZONE:-America/New_York}
      - TZ=${TIME_ZONE:-America/New_York}
      # 2FA handling - restart on timeout to avoid manual intervention
      - TWOFA_TIMEOUT_ACTION=${TWOFA_TIMEOUT_ACTION:-restart}
      - RELOGIN_AFTER_TWOFA_TIMEOUT=${RELOGIN_AFTER_TWOFA_TIMEOUT:-yes}
      - TWOFA_EXIT_INTERVAL=${TWOFA_EXIT_INTERVAL:-60}
      # Auto restart daily to maintain fresh session
      - AUTO_RESTART_TIME=${AUTO_RESTART_TIME:-11:59 PM}
      # Session handling
      - EXISTING_SESSION_DETECTED_ACTION=${EXISTING_SESSION_DETECTED_ACTION:-primary}
      # API settings
      - READ_ONLY_API=${READ_ONLY_API:-no}
      - ALLOW_BLIND_TRADING=${ALLOW_BLIND_TRADING:-no}
      # Optional settings (leave empty to use defaults)
      - TWS_SETTINGS_PATH=${TWS_SETTINGS_PATH:-}
      - TWS_ACCEPT_INCOMING=${TWS_ACCEPT_INCOMING:-}
      - BYPASS_WARNING=${BYPASS_WARNING:-}
      - CUSTOM_CONFIG=${CUSTOM_CONFIG:-NO}
    # VNC bound to localhost only - accessible via SSH tunnel, NOT from internet
    ports:
      - "127.0.0.1:5900:5900"
    # Optional: persist TWS settings across container restarts
    # volumes:
    #   - tws-settings:/home/ibgateway/Jts

  # ===========================================================================
  # IB API - FastAPI wrapper with JWT authentication
  # ===========================================================================
  ib-api:
    build:
      context: ./ib-api
      dockerfile: Dockerfile
    restart: always
    depends_on:
      - ib-gateway
    environment:
      # IB Gateway connection (uses Docker internal network)
      - IB_GATEWAY_HOST=ib-gateway
      - TRADING_MODE=${TRADING_MODE:-paper}
      # JWT Authentication (REQUIRED)
      - JWT_SECRET=${JWT_SECRET:?}
      - JWT_EXPIRE_MINUTES=${JWT_EXPIRE_MINUTES:-30}
      # API Credentials (REQUIRED)
      - API_USERNAME=${API_USERNAME:?}
      - API_PASSWORD=${API_PASSWORD:?}
    ports:
      # Only ib-api is exposed - Coolify will proxy this to HTTPS
      # External 8401 maps to internal 8000 (mirrors IB's 4001 pattern)
      - "8401:8000"

# Optional: named volume for settings persistence
# volumes:
#   tws-settings:
